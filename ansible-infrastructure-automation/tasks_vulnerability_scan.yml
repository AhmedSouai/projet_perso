---
- name: Exécuter un scan de vulnérabilités avec OpenSCAP
  command: oscap xccdf eval --profile stig /usr/share/xml/scap/ssg/content/ssg-ubuntu1804-ds.xml --results /tmp/scan_results.xml --report /tmp/scan_report.html
  register: scan_result
  ignore_errors: yes
- name: Lire le fichier de résultats du scan
  command: xmllint --xpath "string(//xccdf:EvaluationResult//xccdf:Value[@id='total'])" /tmp/scan_results.xml
  register: vulnerability_count
  failed_when: false

  
- name: Extraire les vulnérabilités détectées et afficher les détails
  command: xmllint --xpath "//xccdf:EvaluationResult//xccdf:RuleResult" /tmp/scan_results.xml
  register: vulnerability_details
  failed_when: false

- name: Afficher les détails des vulnérabilités
  debug:
    msg: |
      Vulnérabilité : {{ item.xpath('string(@id)') }}
      Gravité : {{ item.xpath('string(@severity)') }}
      Description : {{ item.xpath('string(ccdf:Description)') }}
  loop: "{{ vulnerability_details.stdout.split('\n') }}"
  when: vulnerability_details.stdout is defined
