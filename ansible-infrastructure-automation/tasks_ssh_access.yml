---
- name: Configurer un utilisateur SSH sécurisé

  - name: Vérifier si l'utilisateur secadmin existe déjà
    getent:
      database: passwd
      key: secadmin
    register: user_exists
    failed_when: false

  - name: Ajouter un utilisateur SSH sécurisé (secadmin)
    user:
      name: secadmin
      groups: sudo
      shell: /bin/bash
      create_home: yes
    when: user_exists.found == false

  - name: Copier la clé SSH pour secadmin
    authorized_key:
      user: secadmin
      state: present
      key: "{{ lookup('file', '/chemin/vers/ma/clé_publique_rsa.pub') }}"
    when: user_exists.found == true

  - name: Désactiver l'accès SSH pour root
    lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^PermitRootLogin'
      line: 'PermitRootLogin no'
    notify:
      - restart_ssh
    when: user_exists.found == false

  - name: Limiter l'accès SSH à secadmin
    lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^AllowUsers'
      line: 'AllowUsers secadmin'
    notify:
      - restart_ssh
    when: user_exists.found == false

  - name: Redémarrer le service SSH
    service:
      name: ssh
      state: restarted
    when: user_exists.found == false

  handlers:
    - name: restart_ssh
      service:
        name: ssh
        state: restarted
